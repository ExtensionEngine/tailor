<template>
  <div infinite-wrapper class="catalog-wrapper">
    <v-container :class="['catalog', { 'catalog-empty': !hasRepositories }]">
      <v-layout row class="catalog-actions">
        <create-repository/>
        <v-flex md4 sm10 offset-md4 offset-sm1>
          <search :value="queryParams.search" @update="setSearch($event)"/>
        </v-flex>
        <v-flex md3 sm1 class="text-sm-left pl-2">
          <v-tooltip open-delay="800" right>
            <template v-slot:activator="{ on }">
              <v-btn v-on="on" @click="togglePinned()" icon flat>
                <v-icon :color="showPinned ? 'lime accent-3' : 'primary lighten-4'">
                  mdi-pin
                </v-icon>
              </v-btn>
            </template>
            <span>Toggle pinned</span>
          </v-tooltip>
          <select-order :sortBy="sortBy" @update="setOrder" class="pl-2"/>
        </v-flex>
      </v-layout>
      <v-layout row wrap>
        <v-flex
          v-for="({ courseUser, schema, ...repository }) in repositories"
          :key="repository._cid"
          class="card-wrapper px-2 py-3 xs4">
          <repository-card
            v-bind="repository"
            :pinned="courseUser && courseUser.pinned"
            :schema="getSchema(schema)"
            @pin="state => pin({ id: repository.id, pin: state })"
            @open="open(repository)"/>
        </v-flex>
      </v-layout>
      <infinite-loading ref="loader" @infinite="load">
        <div slot="spinner" class="spinner">
          <v-progress-circular color="primary" indeterminate/>
        </div>
        <div slot="no-results" class="no-results subheading">
          <v-alert
            :value="!loading"
            color="blue-grey lighten-4"
            icon="mdi-cloud-search-outline"
            outline>
            {{ noRepositoriesMessage }}
          </v-alert>
        </div>
        <span slot="no-more"></span>
      </infinite-loading>
    </v-container>
  </div>
</template>

<script>
import { getSchema, MissingSchemaError } from '@/../config/shared/activities';
import { mapActions, mapGetters, mapMutations, mapState } from 'vuex';
import CreateRepository from './Create';
import get from 'lodash/get';
import InfiniteLoading from 'vue-infinite-loading';
import isEqual from 'lodash/isEqual';
import pick from 'lodash/pick';
import RepositoryCard from './Card';
import Search from './Search';
import SelectOrder from './SelectOrder';

export default {
  inheritAttrs: false,
  data: () => ({ loading: true }),
  computed: {
    ...mapState('courses', {
      sortBy: state => state.$internals.sort,
      showPinned: 'showPinned'
    }),
    ...mapGetters('courses', {
      repositories: 'courses',
      queryParams: 'courseQueryParams',
      hasMoreResults: 'hasMoreResults'
    }),
    loader() {
      return get(this.$refs, 'loader.stateChanger', {});
    },
    hasRepositories() {
      return !!this.repositories.length;
    },
    noRepositoriesMessage() {
      if (this.loading) return;
      if (this.hasRepositories) return;
      if (this.queryParams.search) return 'No matches found';
      if (this.showPinned) return '0 pinned items';
      return '0 available repositories';
    }
  },
  methods: {
    ...mapActions('courses', ['fetch', 'pin']),
    ...mapMutations('courses', ['togglePinned', 'setSearch', 'setOrder']),
    getSchema(id) {
      try {
        return getSchema(id);
      } catch (err) {
        if (MissingSchemaError.isMissingSchemaError(err)) return;
        throw err;
      }
    },
    load() {
      this.loading = true;
      return this.fetch().then(() => {
        if (this.hasRepositories) this.loader.loaded();
        if (!this.hasMoreResults) this.loader.complete();
        this.loading = false;
      });
    },
    open({ id }) {
      this.$router.push({
        name: 'course',
        params: { courseId: id }
      });
    }
  },
  watch: {
    repositories() {
      // If all items get unpinned
      if (!this.hasRepositories && this.showPinned) this.loader.reset();
    },
    queryParams(val, oldVal) {
      const attrs = ['search', 'sortOrder', 'sortBy', 'pinned'];
      const changedFilter = !isEqual(pick(val, attrs), pick(oldVal, attrs));
      if (!changedFilter) return;
      this.load().then(() => this.loader.reset());
    }
  },
  components: {
    CreateRepository,
    InfiniteLoading,
    RepositoryCard,
    Search,
    SelectOrder
  }
};
</script>

<style lang="scss" scoped>
.catalog {
  @media (min-width: 1440px) {
    max-width: 1185px !important;
  }

  &-wrapper {
    position: relative;
  }

  &::before {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 230px;
    background: #455a64;
    box-shadow:
      0 3px 5px -1px rgba(0,0,0,0.2),
      0 5px 8px 0 rgba(0,0,0,0.14),
      0 1px 14px 0 rgba(0,0,0,0.12);
  }

  &#{&}-empty::before {
    width: 100%;
    height: 100%;
  }

  &-actions {
    position: relative;
    margin-bottom: 20px;
    padding-top: 12px;

    /deep/ .add-repo {
      top: 10px;
      right: 12px;
    }
  }

  .card-wrapper:empty {
    display: none;
  }
}

.spinner, .no-results {
  margin-top: 40px;
}
</style>
