<template>
  <div class="select-element">
    <div
      v-if="!showQuestions"
      :style="{ 'max-width': `${maxWidth}px` }"
      class="elements">
      <div
        v-for="(row, index) in rows"
        :key="index"
        class="row">
        <div
          v-for="element in row"
          :key="element.type"
          :class="columnWidth"
          @click="setType(element.type)"
          class="element-type">
          <span :class="element.ui.icon" class="mdi"></span>
          <span>{{ element.name }}</span>
        </div>
      </div>
    </div>
    <select-question
      v-if="showQuestions"
      :questions="questions"
      @selected="setSubtype"/>
  </div>
</template>

<script>
import chunk from 'lodash/chunk';
import countBy from 'lodash/countBy';
import filter from 'lodash/filter';
import includes from 'lodash/includes';
import { isQuestion } from '../utils';
import SelectQuestion from './SelectQuestion';
import sortBy from 'lodash/sortBy';

const ELEMENTS_PER_ROW = 6;

export default {
  name: 'select-element',
  inject: ['$teRegistry'],
  props: {
    activity: { type: Object, default: null },
    include: { type: Array, default: null },
    rowSize: { type: Number, default: ELEMENTS_PER_ROW }
  },
  data() {
    return { type: null };
  },
  computed: {
    registry() {
      return sortBy(this.$teRegistry.get(), 'position');
    },
    rows() {
      return chunk(this.elements, this.rowSize);
    },
    columns() {
      return Math.min(this.elements.length, this.rowSize);
    },
    elements() {
      const result = filter(this.registry, it => !isQuestion(it.type));
      const elementTypes = countBy(this.registry, 'type');
      if (elementTypes.QUESTION || elementTypes.ASSESSMENT) {
        result.push({
          name: 'Assessment',
          type: 'ASSESSMENT',
          ui: { icon: 'mdi-help' }
        });
      }
      if (elementTypes.QUESTION || elementTypes.REFLECTION) {
        result.push({
          name: 'Reflection',
          type: 'REFLECTION',
          ui: { icon: 'mdi-comment-question-outline' }
        });
      }
      if (!this.include) return result;
      return filter(result, it => includes(this.include, it.type));
    },
    questions() {
      if (!this.showQuestions) return [];
      const types = ['QUESTION', this.type];
      return filter(this.registry, it => types.includes(it.type));
    },
    showQuestions() {
      return isQuestion(this.type);
    },
    columnWidth() {
      return `col-xs-${Math.floor(12 / this.columns)}`;
    },
    maxWidth() {
      // Set the maximum width of the select component container in the
      // increments of 150px, with the baseline of 2 elements having 200px width
      return 200 + (this.columns - 2) * 150;
    }
  },
  methods: {
    setType(type) {
      if (isQuestion(type)) {
        this.type = type;
        return;
      }
      this.$emit('selected', { type });
      this.close();
    },
    setSubtype(subtype) {
      this.$emit('selected', { type: this.type, subtype });
      this.close();
    },
    close() {
      this.type = null;
    }
  },
  created() {
    const assessments = filter(this.elements, { type: 'ASSESSMENT' });
    const reflections = filter(this.elements, { type: 'REFLECTION' });
    if (assessments.length === this.elements.length) this.type = 'ASSESSMENT';
    if (reflections.length === this.elements.length) this.type = 'REFLECTION';
  },
  components: { SelectQuestion }
};
</script>

<style lang="scss" scoped>
.select-element {
  margin: 0 auto;
}

.elements {
  margin: 0 auto;

  .row {
    padding-bottom: 30px;
  }
}

.element-type {
  &:hover {
    color: #42b983;
    cursor: pointer;
  }

  span {
    display: block;
    font-size: 16px;
  }

  .mdi {
    padding-bottom: 7px;
    font-size: 30px;
  }
}
</style>
